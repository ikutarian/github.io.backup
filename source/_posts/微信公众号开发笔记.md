---
title: 微信公众号开发笔记
date: 2019-01-06 13:22:28
tags:
  - 公众号
  - 微信
categories:
  - 公众号
---

微信公众号开发时的一些笔记，防止忘记

<!-- more -->

# 公众号类型

- 服务号
- 订阅号
- 企业号

区别可以看[公众平台服务号、订阅号、企业微信、小程序的相关说明](http://kf.qq.com/faq/170815aUZjeQ170815mU7bI7.html)

{% asset_img a12daf5a6a2cf4c01618569b1b9e5881.jpg %}

# 开发模式与编辑模式

微信公众号有两种模式：

- 开发模式
- 编辑模式

两者是**互斥**的，开启了开发模式，就不能使用编辑模式的功能，开启了编辑模式就不能使用开发模式的功能。作为开发人员，编辑模式用不着，都是使用开发模式

# 数据流向

在数据的流动过程中，涉及三个角色：

- 用户
- 微信服务器
- 开发者服务器

数据在这三个角色之间流动。一张图来说明

{% asset_img Snipaste_2019-01-06_13-38-55.png %}

# 外网映射工具

为了开发时方便调试，需要一个外网映射工具，把微信服务器的请求转发到自己的开发电脑上，这样就可以方便地调试代码了

工具目前推荐使用[natapp](https://natapp.cn/)，官网有一个[一分钟快速使用教程](https://natapp.cn/article/natapp_newbie)可以看，看了就会用了

# 开发模式接入

在[微信公众平台技术文档-开发开发-接入指南](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319)有具体说明

在配置的时候，微信会发送一个 HTTP GET 请求到我们的服务器，携带 4 个参数

|参数|描述|
|:--|:--|
|signature|微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。|
|timestamp|时间戳|
|nonce|随机数|
|echostr|随机字符串|

需要对这些参数进行校验，步骤如下：

1. `token`、`timestamp`、`nonce` 进行字典排序得到一个字符串
2. 再把字符串进行 SHA1 加密得到一个新的字符串
3. 判断新的字符串和 `signature` 是否相等。如果相等，说明这个请求是来自微信服务器的请求，不是非法请求，于是把 `echostr` 原样返回

```java
public static boolean checkSignature(String token, String signature, String timestamp, 
        String nonce, String echostr) {
    String[] parameters = {token, timestamp, nonce};
    Arrays.sort(parameters);

    StringBuilder str = new StringBuilder();
    for (String parameter : parameters) {
        str.add(parameter);
    }

    String sha1Str = DigestUtils.sha1Hex(str.toString());

    return signature.equals(sha1Str);
}
```

```java
@Controller
public class WxController {

    @GetMapping("wx")
    public void validate(String signature, String timestamp, String nonce, String echostr, 
        HttpServletResponse response) {
        PrintWriter out = null;
		try {
            out = response.getWriter();
			if(checkSignature(signature, timestamp, nonce)){
				out.write(echostr);
			}
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			out.close();
		}
    }
}
```